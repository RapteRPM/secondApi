<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="frontend_integration.js"></script>
</head>
<body class="crud-page">

<!-- NAVBAR -->
<nav class="navbar navbar-custom navbar-dark p-3">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1"><i class="fas fa-box"></i> Dashboard - Productos</span>
        <div class="d-flex">
            <a href="index.html" class="btn btn-outline-light me-2">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
            </a>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- ESTAD√çSTICAS -->
    <div class="row mb-4" id="statsContainer">
        <div class="col-md-4">
            <div class="stat-card bg-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-box fa-2x me-3"></i>
                    <div>
                        <h3 id="totalProductos">0</h3>
                        <small>Total Productos</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card bg-success text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h3 id="totalCategorias">0</h3>
                        <small>Categor√≠as</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card bg-info text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-warehouse fa-2x me-3"></i>
                    <div>
                        <h3 id="inventarioTotal">0</h3>
                        <small>Inventario Total</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOT√ìN AGREGAR -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">Gesti√≥n de Productos</h3>
        <button class="btn btn-main" onclick="mostrarFormulario()">
            <i class="fas fa-plus"></i> Agregar Producto
        </button>
    </div>

    <!-- FORMULARIO -->
    <div id="formProducto" class="card-producto mb-4 hidden">
        <h4 id="formTitle">Agregar Producto</h4>
        <div class="row">
            <div class="col-md-8">
                <label class="form-label">Nombre del Producto</label>
                <input id="prodNombre" class="form-control" type="text" placeholder="Ej: Laptop Dell Inspiron">
            </div>
            <div class="col-md-4">
                <label class="form-label">Inventario</label>
                <input id="prodInventario" class="form-control" type="number" placeholder="10" min="0">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <label class="form-label">Categor√≠a</label>
                <select id="prodCategoria" class="form-control">
                    <option value="">Cargando categor√≠as...</option>
                </select>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-main me-2" onclick="guardarProducto()">
                <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn btn-secondary" onclick="cancelarForm()">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>

    <!-- LISTA DE PRODUCTOS -->
    <div class="row" id="productosGrid">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Cargando productos...</p>
        </div>
    </div>

</div>

<!-- Modal para detalles -->
<div class="modal fade" id="detallesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> Detalles del Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let productos = [];
    let categorias = [];
    let editIndex = null;
    let detallesModal = null;

    // Inicializar cuando carga la p√°gina
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Dashboard iniciando...');
        detallesModal = new bootstrap.Modal(document.getElementById('detallesModal'));
        
        // Asegurarse de que el token se carga desde localStorage
        if (!authToken) {
            authToken = localStorage.getItem('authToken');
        }
        
        // Verificar si hay token de sesi√≥n
        if (!authToken) {
            console.log('‚ö†Ô∏è No hay token de sesi√≥n, redirigiendo al login');
            alert('Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.');
            window.location.href = 'index.html';
            return;
        }
        
        console.log('‚úÖ Token encontrado, cargando dashboard...');
        await cargarDatos();
    });

    // Cargar todos los datos
    async function cargarDatos() {
        try {
            console.log('üì¶ Cargando datos...');
            await Promise.all([
                cargarProductos(),
                cargarCategorias()
            ]);
            actualizarEstadisticas();
        } catch (error) {
            console.error('‚ùå Error al cargar datos:', error);
        }
    }

    // Cargar productos desde la API
    async function cargarProductos() {
        try {
            console.log('üì¶ Cargando productos...');
            const response = await obtenerProductos();
            
            // La API puede devolver diferentes estructuras
            if (response && response.data) {
                productos = response.data;
            } else if (Array.isArray(response)) {
                productos = response;
            } else {
                productos = [];
            }
            
            console.log('‚úÖ Productos cargados:', productos.length);
            renderProductos();
        } catch (error) {
            console.error('‚ùå Error al cargar productos:', error);
            document.getElementById("productosGrid").innerHTML = 
                '<div class="col-12"><div class="alert alert-danger">‚ö†Ô∏è Error al cargar los productos. Verifica la conexi√≥n con el servidor.</div></div>';
        }
    }

    // Cargar categor√≠as desde la API
    async function cargarCategorias() {
        try {
            console.log('üìÇ Cargando categor√≠as...');
            const response = await obtenerCategorias();
            
            if (response && response.data) {
                categorias = response.data;
            } else if (Array.isArray(response)) {
                categorias = response;
            } else {
                categorias = [];
            }
            
            console.log('‚úÖ Categor√≠as cargadas:', categorias.length);
            renderSelectCategorias();
        } catch (error) {
            console.error('‚ùå Error al cargar categor√≠as:', error);
            categorias = [];
            renderSelectCategorias();
        }
    }

    // Renderizar select de categor√≠as
    function renderSelectCategorias() {
        const select = document.getElementById("prodCategoria");
        
        if (!categorias || categorias.length === 0) {
            select.innerHTML = '<option value="">No hay categor√≠as disponibles</option>';
            return;
        }
        
        let html = '<option value="">Selecciona una categor√≠a</option>';
        categorias.forEach(cat => {
            html += `<option value="${cat.id}">${cat.nombreCategoria}</option>`;
        });
        
        select.innerHTML = html;
    }

    // Renderizar productos en la interfaz
    function renderProductos() {
        const grid = document.getElementById("productosGrid");
        
        if (!productos || productos.length === 0) {
            grid.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <h4>No hay productos registrados</h4>
                        <p>Comienza agregando tu primer producto usando el bot√≥n de arriba.</p>
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        productos.forEach((item, index) => {
            const categoria = categorias.find(c => c.id === item.categoria_id);
            const categoriaNombre = categoria ? categoria.nombreCategoria : 'Sin categor√≠a';
            
            html += `
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-box"></i></span>
                            <span class="badge bg-light text-dark">${categoriaNombre}</span>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${item.nombre}</h5>
                            <div class="mb-2">
                                <strong>ID:</strong> #${item.id}<br>
                                <strong>Inventario:</strong> ${item.inventario} unidades<br>
                                <strong>Categor√≠a:</strong> ${categoriaNombre}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="verDetalles(${index})">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="editarProducto(${index})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="eliminarProducto(${index})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        grid.innerHTML = html;
    }

    // Mostrar formulario para agregar
    function mostrarFormulario() {
        editIndex = null;
        document.getElementById("formTitle").innerText = "Agregar Producto";
        limpiarFormulario();
        document.getElementById("formProducto").classList.remove("hidden");
    }

    // Guardar producto (crear o actualizar)
    async function guardarProducto() {
        const nombre = document.getElementById("prodNombre").value.trim();
        const inventario = parseInt(document.getElementById("prodInventario").value);
        const categoria_id = parseInt(document.getElementById("prodCategoria").value);

        // Validaciones
        if (!nombre) {
            alert('Por favor ingresa el nombre del producto');
            return;
        }

        if (isNaN(inventario) || inventario < 0) {
            alert('Por favor ingresa un inventario v√°lido');
            return;
        }

        if (!categoria_id) {
            alert('Por favor selecciona una categor√≠a');
            return;
        }

        try {
            if (editIndex !== null) {
                // Actualizar producto existente
                const item = productos[editIndex];
                const response = await actualizarProducto(
                    item.id, nombre, inventario, categoria_id
                );
                alert('‚úÖ Producto actualizado exitosamente');
                console.log('Actualizado:', response);
            } else {
                // Crear nuevo producto
                const response = await crearProducto(
                    nombre, inventario, categoria_id
                );
                alert('‚úÖ Producto creado exitosamente');
                console.log('Creado:', response);
            }

            cancelarForm();
            await cargarProductos();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al guardar: ' + error.message);
        }
    }

    // Editar producto
    function editarProducto(index) {
        const item = productos[index];
        editIndex = index;
        
        document.getElementById("formTitle").innerText = "Editar Producto";
        document.getElementById("prodNombre").value = item.nombre || '';
        document.getElementById("prodInventario").value = item.inventario || 0;
        document.getElementById("prodCategoria").value = item.categoria_id || '';
        
        document.getElementById("formProducto").classList.remove("hidden");
    }

    // Eliminar producto
    async function eliminarProducto(index) {
        const item = productos[index];
        if (!confirm(`¬øEst√°s seguro de eliminar "${item.nombre}"?`)) {
            return;
        }
        
        try {
            // Usar la funci√≥n del API correctamente
            const response = await apiRequest(`/products/${item.id}`, {
                method: 'DELETE'
            });
            alert('‚úÖ Producto eliminado exitosamente');
            await cargarProductos();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar: ' + error.message);
        }
    }

    // Ver detalles en modal
    function verDetalles(index) {
        const item = productos[index];
        const categoria = categorias.find(c => c.id === item.categoria_id);
        const categoriaNombre = categoria ? categoria.nombreCategoria : 'Sin categor√≠a';
            
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
            <div class="text-center mb-4">
                <div style="font-size: 4rem; margin-bottom: 1rem;"><i class="fas fa-box text-primary"></i></div>
                <h3>${item.nombre}</h3>
                <p class="text-muted">ID: #${item.id}</p>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-info-circle"></i> Informaci√≥n General</h5>
                    <table class="table table-borderless">
                        <tr><td><strong>Nombre:</strong></td><td>${item.nombre}</td></tr>
                        <tr><td><strong>ID:</strong></td><td>#${item.id}</td></tr>
                        <tr><td><strong>Categor√≠a:</strong></td><td>${categoriaNombre}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h5><i class="fas fa-warehouse"></i> Inventario</h5>
                    <table class="table table-borderless">
                        <tr><td><strong>Stock Actual:</strong></td><td class="text-success">${item.inventario} unidades</td></tr>
                        <tr><td><strong>Estado:</strong></td><td>${item.inventario > 0 ? '<i class="fas fa-check text-success"></i> Disponible' : '<i class="fas fa-times text-danger"></i> Agotado'}</td></tr>
                    </table>
                </div>
            </div>
        `;
        
        detallesModal.show();
    }

    // Limpiar formulario
    function limpiarFormulario() {
        document.getElementById("prodNombre").value = '';
        document.getElementById("prodInventario").value = '';
        document.getElementById("prodCategoria").value = '';
    }

    // Cancelar formulario
    function cancelarForm() {
        document.getElementById("formProducto").classList.add("hidden");
        limpiarFormulario();
        editIndex = null;
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
        const totalProductos = productos.length;
        const totalCategorias = categorias.length;
        const inventarioTotal = productos.reduce((sum, item) => sum + (item.inventario || 0), 0);
        
        document.getElementById("totalProductos").textContent = totalProductos;
        document.getElementById("totalCategorias").textContent = totalCategorias;
        document.getElementById("inventarioTotal").textContent = inventarioTotal;
    }
</script>

</body>
</html>
